# k8s-node/tasks/main.yml
---
# - name: Populate service facts
#   service_facts:
# - debug: var=ansible_facts.services['kubelet']
- name: Reset kubeadm before init in case this is not the first run
  command: kubeadm reset -f
  when: k8s_reset_before_init

# this is not going to work because the info has not been copied to the hosts
- name: copy connection info
  copy:
    src: {{ node_connection_string_file }}
    dest: {{ node_connection_string_file }}
    owner: {{ ansible_remote_user }}
    group: {{ ansible_remote_user }}
    mode: 0644

- hosts: all
  vars:
    connection_info: {{ lookup('file', node_connection_string_file ) }}
  tasks:
     - debug: msg="connection string: {{ connection_info }}"

- name: kubeadm join with pre generated token
  command: kubeadm join {{ connection_info }}
